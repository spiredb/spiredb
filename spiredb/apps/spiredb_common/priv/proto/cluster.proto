syntax = "proto3";

package spiredb.cluster;

option java_package = "com.spiredb.cluster";
option go_package = "spiredb/cluster";

// =============================================================================
// Timestamp Oracle Service (TSO)
// =============================================================================

service TSOService {
  // Allocate batch of monotonic timestamps
  rpc GetTimestamp(GetTimestampRequest) returns (GetTimestampResponse);
}

message GetTimestampRequest {
  uint32 count = 1;  // Number of timestamps to allocate (batch)
}

message GetTimestampResponse {
  uint64 start_ts = 1;  // First allocated timestamp
  uint32 count = 2;     // Number allocated
}

// =============================================================================
// Schema Service
// =============================================================================

service SchemaService {
  // Table operations
  rpc CreateTable(CreateTableRequest) returns (CreateTableResponse);
  rpc DropTable(DropTableRequest) returns (Empty);
  rpc GetTable(GetTableRequest) returns (TableSchema);
  rpc ListTables(Empty) returns (TableList);
  
  // Index operations
  rpc CreateIndex(CreateIndexRequest) returns (CreateIndexResponse);
  rpc DropIndex(DropIndexRequest) returns (Empty);
  rpc GetIndex(GetIndexRequest) returns (IndexSchema);
  rpc ListIndexes(ListIndexesRequest) returns (IndexList);

  // Statistics operations
  rpc GetTableStats(GetTableStatsRequest) returns (TableStats);
  rpc UpdateTableStats(UpdateTableStatsRequest) returns (Empty);
}

// Column types (Arrow/DataFusion compatible)
enum ColumnType {
  TYPE_INT8 = 0;
  TYPE_INT16 = 1;
  TYPE_INT32 = 2;
  TYPE_INT64 = 3;
  TYPE_UINT8 = 4;
  TYPE_UINT16 = 5;
  TYPE_UINT32 = 6;
  TYPE_UINT64 = 7;
  TYPE_FLOAT32 = 8;
  TYPE_FLOAT64 = 9;
  TYPE_BOOL = 10;
  TYPE_STRING = 11;
  TYPE_BYTES = 12;
  TYPE_DATE = 13;
  TYPE_TIMESTAMP = 14;
  TYPE_DECIMAL = 15;
  TYPE_LIST = 16;
  TYPE_VECTOR = 17;
}

message ColumnDef {
  string name = 1;
  ColumnType type = 2;
  bool nullable = 3;
  bytes default_value = 4;
  uint32 precision = 5;     // For DECIMAL
  uint32 scale = 6;         // For DECIMAL
  uint32 vector_dim = 7;    // For VECTOR
  ColumnType list_elem = 8; // For LIST element type
}

message CreateTableRequest {
  string name = 1;
  repeated ColumnDef columns = 2;
  repeated string primary_key = 3;
}

message CreateTableResponse {
  uint64 table_id = 1;
}

message DropTableRequest {
  string name = 1;
}

message GetTableRequest {
  oneof identifier {
    uint64 id = 1;
    string name = 2;
  }
}

message TableSchema {
  uint64 id = 1;
  string name = 2;
  repeated ColumnDef columns = 3;
  repeated string primary_key = 4;
  string region_prefix = 5;
  uint64 created_at = 6;
}

message TableList {
  repeated TableSchema tables = 1;
}

// Index types
enum IndexType {
  INDEX_BTREE = 0;
  INDEX_ANODE = 1;
  INDEX_MANODE = 2;
}

message CreateIndexRequest {
  string name = 1;
  string table_name = 2;
  IndexType type = 3;
  repeated string columns = 4;
  map<string, string> params = 5;
}

message CreateIndexResponse {
  uint64 index_id = 1;
}

message DropIndexRequest {
  string name = 1;
}

message GetIndexRequest {
  string name = 1;
}

message IndexSchema {
  uint64 id = 1;
  string name = 2;
  uint64 table_id = 3;
  IndexType type = 4;
  repeated string columns = 5;
  map<string, string> params = 6;
}

message ListIndexesRequest {
  string table_name = 1;  // Optional: filter by table
}

message IndexList {
  repeated IndexSchema indexes = 1;
}

message GetTableStatsRequest {
  string table_name = 1;
}

message TableStats {
  uint64 row_count = 1;
  uint64 size_bytes = 2;
  uint64 last_updated = 3;
  map<string, ColumnStats> column_stats = 4;
}

message ColumnStats {
  uint64 distinct_count = 1;   // For cardinality estimation
  bytes min_value = 2;
  bytes max_value = 3;
  uint64 null_count = 4;
}

message UpdateTableStatsRequest {
  string table_name = 1;
  uint64 row_count = 2;
  uint64 size_bytes = 3;
}

// =============================================================================
// Cluster Service
// =============================================================================

service ClusterService {
  // Region routing
  rpc GetRegion(GetRegionRequest) returns (Region);
  rpc GetRegionByKey(GetRegionByKeyRequest) returns (Region);
  rpc GetTableRegions(GetTableRegionsRequest) returns (RegionList);
  
  // Store management
  rpc GetStore(GetStoreRequest) returns (Store);
  rpc ListStores(Empty) returns (StoreList);
  rpc RegisterStore(RegisterStoreRequest) returns (RegisterStoreResponse);
  rpc Heartbeat(StoreHeartbeat) returns (StoreHeartbeatResponse);
}

message GetRegionRequest {
  uint64 region_id = 1;
}

message GetRegionByKeyRequest {
  bytes key = 1;
}

message GetTableRegionsRequest {
  string table_name = 1;
}

message Region {
  uint64 id = 1;
  bytes start_key = 2;
  bytes end_key = 3;
  repeated Peer peers = 4;
  uint64 leader_store_id = 5;
  uint64 region_epoch = 6;
  RegionState state = 7;
}

enum PeerRole {
  PEER_FOLLOWER = 0;
  PEER_LEADER = 1;
  PEER_LEARNER = 2;
}

message Peer {
  uint64 store_id = 1;
  PeerRole role = 2;
}

enum RegionState {
  REGION_ACTIVE = 0;
  REGION_SPLITTING = 1;
  REGION_MERGING = 2;
}

message RegionList {
  repeated Region regions = 1;
}

message GetStoreRequest {
  uint64 store_id = 1;
}

message Store {
  uint64 id = 1;
  string address = 2;
  StoreState state = 3;
  uint64 capacity = 4;
  uint64 available = 5;
  uint32 region_count = 6;
  map<string, string> labels = 7;
}

enum StoreState {
  STORE_UP = 0;
  STORE_DOWN = 1;
  STORE_TOMBSTONE = 2;
}

message StoreList {
  repeated Store stores = 1;
}

message RegisterStoreRequest {
  string address = 1;
  uint64 capacity = 2;
  map<string, string> labels = 3;
}

message RegisterStoreResponse {
  uint64 store_id = 1;
}

message StoreHeartbeat {
  uint64 store_id = 1;
  string address = 2;           // Node name for heartbeat routing
  uint64 available = 3;
  uint32 region_count = 4;
  repeated RegionStats region_stats = 5;
}

message RegionStats {
  uint64 region_id = 1;
  uint64 approximate_size = 2;
  uint64 approximate_keys = 3;
  uint64 qps = 4;
}

message StoreHeartbeatResponse {
  repeated ScheduledTask tasks = 1;
}

// Task scheduled by PD leader for store to execute
message ScheduledTask {
  uint64 task_id = 7;            // Unique task identifier
  uint64 leader_epoch = 8;       // Raft term when task was issued (for stale task detection)
  
  oneof task {
    SplitRegion split = 1;
    MergeRegions merge = 2;
    TransferLeader transfer_leader = 3;
    AddPeer add_peer = 4;
    RemovePeer remove_peer = 5;
    CompactRegion compact = 6;
  }
}

// Split a region at the given key
message SplitRegion {
  uint64 region_id = 1;
  bytes split_key = 2;           // Key to split at
  uint64 new_region_id = 3;      // Pre-allocated ID for new region
  uint64 new_peer_id = 4;        // Pre-allocated peer ID
}

// Merge two adjacent regions
message MergeRegions {
  uint64 source_region_id = 1;   // Region to merge from (will be deleted)
  uint64 target_region_id = 2;   // Region to merge into
}

// Transfer region leadership to another store
message TransferLeader {
  uint64 region_id = 1;
  uint64 from_store_id = 2;
  uint64 to_store_id = 3;
}

// Add a peer (replica) to a region
message AddPeer {
  uint64 region_id = 1;
  uint64 store_id = 2;           // Store to add as replica
  uint64 peer_id = 3;            // Pre-allocated peer ID
  bool is_learner = 4;           // Start as learner before promoting
}

// Remove a peer from a region
message RemovePeer {
  uint64 region_id = 1;
  uint64 store_id = 2;
  uint64 peer_id = 3;
}

// Trigger manual compaction for a region
message CompactRegion {
  uint64 region_id = 1;
  bytes start_key = 2;           // Optional: compact range start
  bytes end_key = 3;             // Optional: compact range end
}

// =============================================================================
// Plugin Service
// =============================================================================

service PluginService {
  rpc InstallPlugin(InstallPluginRequest) returns (InstallPluginResponse);
  rpc UninstallPlugin(UninstallPluginRequest) returns (Empty);
  rpc ListPlugins(Empty) returns (PluginList);
  rpc ReloadPlugin(ReloadPluginRequest) returns (Empty);
}

enum PluginType {
  PLUGIN_INDEX = 0;
  PLUGIN_STORAGE = 1;
  PLUGIN_FUNCTION = 2;
  PLUGIN_PROTOCOL = 3;
  PLUGIN_AUTH = 4;
}

enum PluginState {
  PLUGIN_LOADED = 0;
  PLUGIN_ERROR = 1;
  PLUGIN_DISABLED = 2;
}

message InstallPluginRequest {
  oneof source {
    string hex_package = 1;   // e.g., "geo_index"
    string github_repo = 2;   // e.g., "user/spiredb-fulltext"
    bytes tarball = 3;        // Raw plugin archive
  }
}

message InstallPluginResponse {
  string name = 1;
  string version = 2;
}

message UninstallPluginRequest {
  string name = 1;
}

message PluginInfo {
  string name = 1;
  string version = 2;
  PluginType type = 3;
  bool has_nif = 4;
  PluginState state = 5;
}

message PluginList {
  repeated PluginInfo plugins = 1;
}

message ReloadPluginRequest {
  string name = 1;
}

// =============================================================================
// Internal Transaction Service (Store-to-Store)
// =============================================================================

service InternalTransactionService {
  // Async commit prewrite with embedded secondaries
  rpc AsyncPrewrite(AsyncPrewriteRequest) returns (AsyncPrewriteResponse);
  
  // Check if secondary locks exist (for async commit resolution)
  rpc CheckSecondaryLocks(CheckSecondaryLocksRequest) returns (CheckSecondaryLocksResponse);
  
  // Resolve locks on keys
  rpc ResolveLock(InternalResolveLockRequest) returns (Empty);
}

message AsyncPrewriteRequest {
  repeated InternalMutation mutations = 1;
  bytes primary_key = 2;
  repeated bytes secondary_keys = 3;  // All secondary keys for async commit
  uint64 start_ts = 4;
  uint64 min_commit_ts = 5;           // Calculated min commit timestamp
  uint64 lock_ttl = 6;
  bytes txn_id = 7;
}

message InternalMutation {
  InternalMutationType type = 1;
  bytes key = 2;
  bytes value = 3;
}

enum InternalMutationType {
  INTERNAL_MUTATION_PUT = 0;
  INTERNAL_MUTATION_DELETE = 1;
}

message AsyncPrewriteResponse {
  bool success = 1;
  repeated InternalKeyError errors = 2;
  uint64 actual_min_commit_ts = 3;    // May be higher due to concurrent reads
}

message InternalKeyError {
  bytes key = 1;
  string error = 2;
  InternalLockInfo lock_info = 3;
}

message InternalLockInfo {
  bytes primary_key = 1;
  uint64 start_ts = 2;
  uint64 ttl = 3;
}

message CheckSecondaryLocksRequest {
  bytes primary_key = 1;
  uint64 start_ts = 2;
  repeated bytes secondary_keys = 3;
}

message CheckSecondaryLocksResponse {
  repeated SecondaryLockStatus statuses = 1;
}

message SecondaryLockStatus {
  bytes key = 1;
  bool locked = 2;
  bool committed = 3;
  uint64 commit_ts = 4;
}

message InternalResolveLockRequest {
  bytes key = 1;
  uint64 start_ts = 2;
  uint64 commit_ts = 3;     // 0 = rollback, >0 = commit
}

// =============================================================================
// Common
// =============================================================================

message Empty {}
